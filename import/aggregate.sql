-- Aggregate way table based on 
CREATE TABLE osmetymology.ways_agg (
	id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	name TEXT,
	way_ids INTEGER[],
	"name:etymology" TEXT,
	"name:etymology:wikipedia" TEXT,
	"name:etymology:wikidata" TEXT,
	geom GEOMETRY(MultiLineString, 3857)
);

-- Import
INSERT INTO osmetymology.ways_agg (name, way_ids, "name:etymology", "name:etymology:wikipedia","name:etymology:wikidata", geom)
SELECT name, array_agg(way_id), "name:etymology", "name:etymology:wikipedia","name:etymology:wikidata", ST_COLLECT(geom)
FROM osmetymology.osm_ways ow 
WHERE name IS NOT NULL AND ("name:etymology" IS NOT NULL OR "name:etymology:wikipedia" IS NOT NULL OR "name:etymology:wikidata" IS NOT NULL)
GROUP by name, "name:etymology", "name:etymology:wikipedia","name:etymology:wikidata";

CREATE INDEX ways_agg_geom_idx ON osmetymology.ways_agg USING gist (geom);
CREATE INDEX ways_agg_name_idx ON osmetymology.ways_agg ("name");
CREATE INDEX ways_agg_name_etymology_wikidata_idx ON osmetymology.ways_agg ("name:etymology:wikidata");

-- :TODO: Cut by municipality polygons
